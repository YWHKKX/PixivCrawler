from gradio_client import Client
import json
import sys
import io

sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

if len(sys.argv) > 1: 
    first_arg = sys.argv[1]
    print("Config file: ", first_arg)
else:
    first_arg = ".\script\example.json"
    print("Warning: No config file provided, Using default example.json")

with open(first_arg, "r", encoding="utf-8") as file:
    config = json.load(file)

client = Client("http://127.0.0.1:7860")

result = client.predict(
    pretrained_model_name_or_path=config["pretrained_model_name_or_path"],
    train_data_dir=config["train_data_dir"],
    output_dir=config["output_dir"],
    output_name=config["output_name"],
    network_dim=config["network_dim"],
    network_alpha=config["network_alpha"],
    train_batch_size=config["train_batch_size"],
    epoch=config["epoch"],
    learning_rate=config["learning_rate"],
    unet_lr=config["unet_lr"],
    text_encoder_lr=config["text_encoder_lr"],
    lr_scheduler=config["lr_scheduler"],
    optimizer=config["optimizer"],
    max_resolution=config["max_resolution"],
    mixed_precision=config["mixed_precision"],
    save_model_as=config["save_model_as"],
    seed=config["seed"],
    LoRA_type=config["LoRA_type"],
    LyCORIS_preset=config["LyCORIS_preset"],
    adaptive_noise_scale=config["adaptive_noise_scale"],
    additional_parameters=config["additional_parameters"],
    ae=config["ae"],
    apply_t5_attn_mask=config["apply_t5_attn_mask"],
    async_upload=config["async_upload"],
    block_alphas=config["block_alphas"],
    block_dims=config["block_dims"],
    block_lr_zero_threshold=config["block_lr_zero_threshold"],
    blocks_to_swap=config["blocks_to_swap"],
    bucket_no_upscale=config["bucket_no_upscale"],
    bucket_reso_steps=config["bucket_reso_steps"],
    bypass_mode=config["bypass_mode"],
    cache_latents=config["cache_latents"],
    cache_latents_to_disk=config["cache_latents_to_disk"],
    caption_dropout_every_n_epochs=config["caption_dropout_every_n_epochs"],
    caption_dropout_rate=config["caption_dropout_rate"],
    caption_extension=config["caption_extension"],
    clip_g=config["clip_g"],
    clip_g_dropout_rate=config["clip_g_dropout_rate"],
    clip_l=config["clip_l"],
    clip_skip=config["clip_skip"],
    color_aug=config["color_aug"],
    constrain=config["constrain"],
    conv_alpha=config["conv_alpha"],
    conv_block_alphas=config["conv_block_alphas"],
    conv_block_dims=config["conv_block_dims"],
    conv_dim=config["conv_dim"],
    cpu_offload_checkpointing=config["cpu_offload_checkpointing"],
    dataset_config=config["dataset_config"],
    debiased_estimation_loss=config["debiased_estimation_loss"],
    decompose_both=config["decompose_both"],
    dim_from_weights=config["dim_from_weights"],
    discrete_flow_shift=config["discrete_flow_shift"],
    dora_wd=config["dora_wd"],
    double_blocks_to_swap=config["double_blocks_to_swap"],
    down_lr_weight=config["down_lr_weight"],
    dynamo_backend=config["dynamo_backend"],
    dynamo_mode=config["dynamo_mode"],
    dynamo_use_dynamic=config["dynamo_use_dynamic"],
    dynamo_use_fullgraph=config["dynamo_use_fullgraph"],
    enable_all_linear=config["enable_all_linear"],
    enable_bucket=config["enable_bucket"],
    extra_accelerate_launch_args=config["extra_accelerate_launch_args"],
    factor=config["factor"],
    flip_aug=config["flip_aug"],
    flux1_cache_text_encoder_outputs=config["flux1_cache_text_encoder_outputs"],
    flux1_cache_text_encoder_outputs_to_disk=config["flux1_cache_text_encoder_outputs_to_disk"],
    flux1_checkbox=config["flux1_checkbox"],
    fp8_base=config["fp8_base"],
    fp8_base_unet=config["fp8_base_unet"],
    full_bf16=config["full_bf16"],
    full_fp16=config["full_fp16"],
    gpu_ids=config["gpu_ids"],
    gradient_accumulation_steps=config["gradient_accumulation_steps"],
    gradient_checkpointing=config["gradient_checkpointing"],
    guidance_scale=config["guidance_scale"],
    highvram=config["highvram"],
    huber_c=config["huber_c"],
    huber_scale=config["huber_scale"],
    huber_schedule=config["huber_schedule"],
    huggingface_path_in_repo=config["huggingface_path_in_repo"],
    huggingface_repo_id=config["huggingface_repo_id"],
    huggingface_repo_type=config["huggingface_repo_type"],
    huggingface_repo_visibility=config["huggingface_repo_visibility"],
    huggingface_token=config["huggingface_token"],
    img_attn_dim=config["img_attn_dim"],
    img_mlp_dim=config["img_mlp_dim"],
    img_mod_dim=config["img_mod_dim"],
    in_dims=config["in_dims"],
    ip_noise_gamma=config["ip_noise_gamma"],
    ip_noise_gamma_random_strength=config["ip_noise_gamma_random_strength"],
    keep_tokens=config["keep_tokens"],
    log_config=config["log_config"],
    log_tracker_config=config["log_tracker_config"],
    log_tracker_name=config["log_tracker_name"],
    log_with=config["log_with"],
    logging_dir=config["logging_dir"],
    logit_mean=config["logit_mean"],
    logit_std=config["logit_std"],
    loraplus_lr_ratio=config["loraplus_lr_ratio"],
    loraplus_text_encoder_lr_ratio=config["loraplus_text_encoder_lr_ratio"],
    loraplus_unet_lr_ratio=config["loraplus_unet_lr_ratio"],
    loss_type=config["loss_type"],
    lowvram=config["lowvram"],
    lr_scheduler_args=config["lr_scheduler_args"],
    lr_scheduler_num_cycles=config["lr_scheduler_num_cycles"],
    lr_scheduler_power=config["lr_scheduler_power"],
    lr_scheduler_type=config["lr_scheduler_type"],
    lr_warmup=config["lr_warmup"],
    lr_warmup_steps=config["lr_warmup_steps"],
    main_process_port=config["main_process_port"],
    masked_loss=config["masked_loss"],
    max_bucket_reso=config["max_bucket_reso"],
    max_data_loader_n_workers=config["max_data_loader_n_workers"],
    max_grad_norm=config["max_grad_norm"],
    max_timestep=config["max_timestep"],
    max_token_length=config["max_token_length"],
    max_train_epochs=config["max_train_epochs"],
    max_train_steps=config["max_train_steps"],
    mem_eff_attn=config["mem_eff_attn"],
    mem_eff_save=config["mem_eff_save"],
    metadata_author=config["metadata_author"],
    metadata_description=config["metadata_description"],
    metadata_license=config["metadata_license"],
    metadata_tags=config["metadata_tags"],
    metadata_title=config["metadata_title"],
    mid_lr_weight=config["mid_lr_weight"],
    min_bucket_reso=config["min_bucket_reso"],
    min_snr_gamma=config["min_snr_gamma"],
    min_timestep=config["min_timestep"],
    mode_scale=config["mode_scale"],
    model_list=config["model_list"],
    model_prediction_type=config["model_prediction_type"],
    module_dropout=config["module_dropout"],
    multi_gpu=config["multi_gpu"],
    multires_noise_discount=config["multires_noise_discount"],
    multires_noise_iterations=config["multires_noise_iterations"],
    network_dropout=config["network_dropout"],
    network_weights=config["network_weights"],
    noise_offset=config["noise_offset"],
    noise_offset_random_strength=config["noise_offset_random_strength"],
    noise_offset_type=config["noise_offset_type"],
    num_cpu_threads_per_process=config["num_cpu_threads_per_process"],
    num_machines=config["num_machines"],
    num_processes=config["num_processes"],
    optimizer_args=config["optimizer_args"],
    persistent_data_loader_workers=config["persistent_data_loader_workers"],
    pos_emb_random_crop_rate=config["pos_emb_random_crop_rate"],
    prior_loss_weight=config["prior_loss_weight"],
    random_crop=config["random_crop"],
    rank_dropout=config["rank_dropout"],
    rank_dropout_scale=config["rank_dropout_scale"],
    reg_data_dir=config["reg_data_dir"],
    rescaled=config["rescaled"],
    resume=config["resume"],
    resume_from_huggingface=config["resume_from_huggingface"],
    sample_every_n_epochs=config["sample_every_n_epochs"],
    sample_every_n_steps=config["sample_every_n_steps"],
    sample_prompts=config["sample_prompts"],
    sample_sampler=config["sample_sampler"],
    save_clip=config["save_clip"],
    save_every_n_epochs=config["save_every_n_epochs"],
    save_every_n_steps=config["save_every_n_steps"],
    save_last_n_epochs=config["save_last_n_epochs"],
    save_last_n_epochs_state=config["save_last_n_epochs_state"],
    save_last_n_steps=config["save_last_n_steps"],
    save_last_n_steps_state=config["save_last_n_steps_state"],
    save_precision=config["save_precision"],
    save_state=config["save_state"],
    save_state_on_train_end=config["save_state_on_train_end"],
    save_state_to_huggingface=config["save_state_to_huggingface"],
    save_t5xxl=config["save_t5xxl"],
    scale_v_pred_loss_like_noise_pred=config["scale_v_pred_loss_like_noise_pred"],
    scale_weight_norms=config["scale_weight_norms"],
    sd3_cache_text_encoder_outputs=config["sd3_cache_text_encoder_outputs"],
    sd3_cache_text_encoder_outputs_to_disk=config["sd3_cache_text_encoder_outputs_to_disk"],
    sd3_checkbox=config["sd3_checkbox"],
    sd3_clip_l=config["sd3_clip_l"],
    sd3_clip_l_dropout_rate=config["sd3_clip_l_dropout_rate"],
    sd3_disable_mmap_load_safetensors=config["sd3_disable_mmap_load_safetensors"],
    sd3_enable_scaled_pos_embed=config["sd3_enable_scaled_pos_embed"],
    sd3_fused_backward_pass=config["sd3_fused_backward_pass"],
    sd3_t5_dropout_rate=config["sd3_t5_dropout_rate"],
    sd3_t5xxl=config["sd3_t5xxl"],
    sd3_text_encoder_batch_size=config["sd3_text_encoder_batch_size"],
    sdxl=config["sdxl"],
    sdxl_cache_text_encoder_outputs=config["sdxl_cache_text_encoder_outputs"],
    sdxl_no_half_vae=config["sdxl_no_half_vae"],
    shuffle_caption=config["shuffle_caption"],
    single_blocks_to_swap=config["single_blocks_to_swap"],
    single_dim=config["single_dim"],
    single_mod_dim=config["single_mod_dim"],
    skip_cache_check=config["skip_cache_check"],
    split_mode=config["split_mode"],
    split_qkv=config["split_qkv"],
    stop_text_encoder_training=config["stop_text_encoder_training"],
    t5xxl=config["t5xxl"],
    t5xxl_device=config["t5xxl_device"],
    t5xxl_dtype=config["t5xxl_dtype"],
    t5xxl_lr=config["t5xxl_lr"],
    t5xxl_max_token_length=config["t5xxl_max_token_length"],
    timestep_sampling=config["timestep_sampling"],
    train_blocks=config["train_blocks"],
    train_double_block_indices=config["train_double_block_indices"],
    train_norm=config["train_norm"],
    train_on_input=config["train_on_input"],
    train_single_block_indices=config["train_single_block_indices"],
    train_t5xxl=config["train_t5xxl"],
    training_comment=config["training_comment"],
    txt_attn_dim=config["txt_attn_dim"],
    txt_mlp_dim=config["txt_mlp_dim"],
    txt_mod_dim=config["txt_mod_dim"],
    unit=config["unit"],
    up_lr_weight=config["up_lr_weight"],
    use_cp=config["use_cp"],
    use_scalar=config["use_scalar"],
    use_tucker=config["use_tucker"],
    v2=config["v2"],
    v_parameterization=config["v_parameterization"],
    v_pred_like_loss=config["v_pred_like_loss"],
    vae=config["vae"],
    vae_batch_size=config["vae_batch_size"],
    wandb_api_key=config["wandb_api_key"],
    wandb_run_name=config["wandb_run_name"],
    weighted_captions=config["weighted_captions"],
    weighting_scheme=config["weighting_scheme"],
    xformers=config["xformers"],
    api_name="/train_model_2"
)

print("Training started, task ID:", result)